{% extends "base.html" %}
{% block content %}
<div class="background-img">
    <!-- Page heading -->
    <div class="nest-heading-container">
        <h2 class="center-align nest-heading">My Nest</h2>
    </div>
    <!-- Bird Stats -->
    <div id="bird-stats-container" class="row">
        <div class="col s12">
            <div class="card-panel">
                <div class=card-heading>
                    <h4 class="center-align"> My Bird Stats </h4>
                </div>
                <!-- Stats -->
                <div class="bird-stats">
                    <div class="light-section">
                        <h5> Observation Stats </h5>
                        <div class="flex-row" id="stats-container">
                            <div id="total-birds-container" class="stat">
                                <div class="stats-label">
                                    <h6>Total Birds Observed</h6> 
                                </div>
                                <div class="circle-container">
                                    <p>{{ total_observations }}</p>
                                </div> 
                            </div>
                            <div id="total-species-container" class="stat">
                                <div class="stats-label">
                                    <h6>Total Bird Species Observed</h6>
                                </div>
                                <div class="circle-container">
                                    <p>{{ species_count }}</p>
                                </div>
                            </div>
                            <div id="average-certainty-container" class="stat">
                                <div class="stats-label">
                                    <h6>Average Certainty</h6>
                                </div>
                                <div class="circle-container">
                                    <p>{{ average_certainty}}/10</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Life list -->
                    <div class="light-section" id="life-list-container">
                        <h5> My life list </h5>
                        <p>
                            A collection and count of all bird species you have seen and submitted on Bird Count.
                        </p>
                        <a href="#life-list-modal{{ user._id }}" class="modal-trigger btn-small">View your life list <i class="fa-solid fa-binoculars"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Observations -->
    <div id="observation-list-nest-container" class="row">
        <div class="col s12">
            <div class="card-panel">
                <h4 class="center-align">My Observations</h4>
                <!-- Find if there are any observations made by session user -->
                {% if observations|selectattr('seen_by', 'equalto', session['user'])|list %}                        
                    <!-- New observation button -->
                    <div class="center-align">
                        <a class="btn-small center-align" href="{{ url_for('add_observation') }}">
                            New Observation 
                            <i class="fa-solid fa-crow"></i>
                            <i class="fa-solid fa-plus"></i>
                        </a>
                    </div>
                    <!-- Observation table -->
                    <table class="highlight light-section">
                        <thead>
                            <tr>
                                <th>Bird Species</th>
                                <th class="hide-mobile">Quantity</th>
                                <th class="hide-mobile">Location</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for observation in observations %}
                                <!-- Only show observations made by session user -->
                                {% if session.user|lower == observation.seen_by|lower %}
                                <tr>
                                    <td href="#my-observation-details{{ observation._id }}" class="modal-trigger">{{ observation.bird_species }}</td>
                                    <td href="#my-observation-details{{ observation._id }}" class="modal-trigger hide-mobile">{{ observation.quantity }}</td>
                                    <td href="#my-observation-details{{ observation._id }}" class="modal-trigger hide-mobile">{{ observation.location }}</td>
                                    <td href="#my-observation-details{{ observation._id }}" class="modal-trigger">{{ observation.date }}</td>
                                    <!-- Edit observation button -->
                                    <td>
                                        <a href="{{ url_for('edit_observation', observation_id=observation._id) }}" class="btn-small mobile-narrow">
                                            <i class="fa-solid fa-pencil"></i>
                                        </a>
                                    </td>
                                    <!-- Delete observation -->
                                    <td>
                                        <!-- Delete button -->
                                        <a href="#confirm-delete" class="btn-small modal-trigger red mobile-narrow">
                                            <i class="fa-regular fa-trash-can "></i>
                                        </a>
                                        <!-- Delete modal -->
                                        <div id="confirm-delete" class="modal">
                                            <div class="modal-content">
                                                <h4>Delete Observation</h4>
                                                <p>
                                                    Are you sure you want to delete this observation? <br>
                                                    Observation selected for deletion: <br>
                                                    {{ observation.bird_species }}, {{ observation.location }}, {{ observation.date }}
                                                </p>
                                            </div>
                                            <!-- Confirm or cancel delete -->
                                            <div class="modal-footer">
                                                <a href="{{ url_for('delete_observation', observation_id=observation._id) }}" class="modal-close btn-flat">Delete</a>
                                                <button class="modal-close btn-flat">Cancel</button>
                                            </div>
                                        </div>
                                    </td>
                                    <!-- Modal for observation details -->
                                    <div id="my-observation-details{{ observation._id }}" class="modal">
                                        <div class="col s12 modal-content">
                                            <div class="card-image">
                                                <img src="{{ url_for('get_image', observation_id=observation._id) }}" alt="Observation Image">
                                                <span class="observation-title">{{ observation.bird_species }} <em>by</em> {{ observation.seen_by }} </span>
                                            </div>
                                            <div class="card-content">
                                                <p>
                                                    Quantity: {{ observation.quantity }} <br>
                                                    Certainty: {{ observation.certainty }}/10 <br>
                                                    location: {{ observation.location }} <br>
                                                    Seen on: {{ observation.date }} @ {{ observation.time }} <br>
                                                    Notes from {{observation.seen_by}}: <br>
                                                    {{ observation.notes }}
                                                </p>
                                            </div>
                                            <div class="modal-footer">
                                                <button class="modal-close btn-flat">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                <!-- No observations submitted message -->
                {% else %}
                    <h6>You haven't submitted any observations yet</h6>
                    <a class="btn-small" href="{{ url_for('add_observation') }}">
                        Add Observation
                        <i class="fa-solid fa-crow"></i>
                        <i class="fa-solid fa-plus"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Contact Admin -->
    <div id="contact-admin-container" class="row">
        <div class="col s12">
            <div class="card-panel">
                <h4 class="center-align">Contact Admin</h4>
                <p class="center-align"> If you have any queries, you can get in touch with the admin below. Their response will appear in your pigeon hole. </p>
                <div class="row">
                    <!-- Messages -->
                    <a href="#pigeon-hole" class="btn-small modal-trigger col s12 m6 l6 tooltipped" data-position="bottom" data-tooltip="Messages from the admin will appear here">
                        Pigeon Hole 
                        <i class="fa-solid fa-envelope"></i> 
                    </a>
                    <!-- Contact Admin -->
                    <a href="#contact-admin" class="btn-small col s12 m6 l6 modal-trigger tooltipped" data-position="bottom" data-tooltip="Get in touch with the admin if you have a query"> 
                        Contact admin 
                        <i class="fa-solid fa-circle-info"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Account Settings -->
    <div id="account-settings-container" class="row">
        <div class="col s12">
            <div class="card-panel">
                <!-- Section heading -->
                <h4 class="center-align">My Account</h4>
                <div class="privacy card-panel" id="edit-privacy-container">
                    <h5>Edit privacy settings</h5> 
                    <!-- Edit visibility -->
                    <div class="light-section-less-padding" id="edit-visibility-container">
                        <form id="visibility-form" method="POST" action="{{ url_for('edit_user_visibility', user_id=user._id) }}">
                            <h6>Visibility</h6>
                            <p>
                                Set the visibility of your observations to the community. If set the invisible your observations will not 
                                appear in the community observations. You will still be able to see your observations in your nest.
                            </p>
                            <div class="switch">
                                <label class="tooltipped" data-position="bottom" data-tooltip="Changes are updated immediately">
                                    Invisible
                                    <input id="visibility-switch" name="visibility-switch" type="checkbox" {% if user.visible is true %} checked {% endif %}>
                                    <span class="lever"></span>
                                    Visible
                                </label>
                            </div>
                        </form>
                    </div>
                    <!-- Edit anonymity -->
                    <div class="light-section-less-padding">
                        <form id="anonymous-form" method="POST" action="{{ url_for('edit_user_anonymous', user_id=user._id) }}">
                            <h6>Anonymity</h6>
                            <p>
                                Set the anonymity of your observations to the community. If set to 'anonymous' your observations will 
                                still be visible to the community but your username will be hidden.
                            </p>
                            <div class="switch">
                                <label class="tooltipped" data-position="bottom" data-tooltip="Changes are updated immediately">
                                    Named
                                    <input id="anonymous-switch" name="anonymous-switch" type="checkbox" {% if user.anonymous is true %} checked {% endif %}>
                                    <span class="lever"></span>
                                    Anonymous
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="edit-details card-panel"> 
                    <h5>Edit Account Details</h5>
                    <div class="row">
                        <!-- Edit Email -->
                        <div class="light-section-less-padding col s12 m12 l6" id="edit-email-container">
                            <p> Email: {{ user.email }}</p>
                            <a href="#email-modal" class="modal-trigger tooltipped btn-small" data-position="right" data-tooltip="Edit your email address">
                                <i class="fa-solid fa-pencil"></i>
                            </a>
                        </div>
                        <!-- Edit experience -->
                        <div class="light-section-less-padding col s12 m12 l6" id="edit-experience-container">
                            <p> Experience: {{ user.experience }}/6</p>
                            <a href="#experience-modal" class="modal-trigger tooltipped btn-small" data-position="right" data-tooltip="Edit your experience level">
                                <i class="fa-solid fa-pencil"></i>
                            </a>
                        </div>    
                    </div>            
                </div>
                <!-- Delete Account -->
                <div class="delete-account card-panel">
                    <h5>Delete Account</h5>
                    <a href="#confirm-delete-account{{ user._id }}" class="modal-trigger btn-small red" id="delete-account-button">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        DELETE ACCOUNT
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- New Message Modal -->
    <div id="contact-admin" class="modal">
        <div class="card-panel modal-content">
            <div class="card-heading ">
                <h4> Contact Admin </h4>
            </div>
            <div class="contact-form-container">
                <!-- Contact Form -->
                <form method="POST" action="{{ url_for('new_message') }}">
                    <!-- Sender pre-filled field -->
                    <div class="row">
                        <div class="input-field col s12 hidden">
                            <input id="sender" name="sender" type="text" value=" {{ session.user }} "
                                pattern="^[a-zA-Z\s]{2,}$">
                            <label for="sender">Sender</label>
                        </div>
                    </div>
                    <!-- Recipient pre-filled field -->
                    <div class="row">
                        <div class="input-field col s12 hidden">
                            <input id="recipient" name="recipient" type="text" value="admin" pattern="^[a-zA-Z\s]{2,}$">
                            <label for="recipient">Recipient</label>
                        </div>
                    </div>
                    <!-- Subject field -->
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="subject" name="subject" type="text" pattern="^[a-zA-Z\s]{2,}$" required>
                            <label for="subject">Subject</label>
                        </div>
                    </div>
                    <!-- Message body field -->
                    <div class="row">
                        <div class="input-field col s12">
                            <textarea id="body" name="body" class="materialize-textarea" required></textarea>
                            <label for="body">Type your message</label>
                        </div>
                    </div>
                    <!-- Send button -->
                    <div class="row">
                        <button type="submit" class="col s12 btn-large">
                            Send message <i class="fa-regular fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="modal-close btn-flat">Cancel</div>
                </form>
            </div>
        </div>
    </div>
    <!-- Life List Modal -->
    <div class="modal" id="life-list-modal{{ user._id }}">
        <div class="modal-content">
            <div class="row">
                <div class="col s12 m5">
                    <div class=card-heading>
                        <!-- Life list content -->
                        <h4> My life list </h4>
                        <!-- Display list if not empty -->
                        {% if tally|length > 0 %}
                            <table>
                                <thead>
                                    <tr>
                                        <th> Bird Species </th>
                                        <th> Quantity </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bird in tally %}
                                    <tr>
                                        <td> {{ bird._id }}</td>
                                        <td> {{ bird.totalQuantity }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        <!-- Hide list and display message explaining empty list -->
                        {% else %}
                            <h6>You haven't got any birds in your nest</h6>
                            <a class="btn-small" href="{{ url_for('add_observation') }}">
                                Add Observation
                                <i class="fa-solid fa-crow"></i>
                                <i class="fa-solid fa-plus"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pigeon Hole Modal -->
    <div class="row modal pigeon-hole" id="pigeon-hole">
        <div class="col s12">
            <div class="card-panel">
                <div class=card-heading>
                    <!-- Messages list -->
                    <h4 class="center-align">
                        Recieved Messages
                    </h4>
                    <!-- Display messages if there are any addressed to the session user -->
                    {% if messages|selectattr('recipient', 'equalto', session['user'])|list %}
                        <ul class="collapsible">
                            {% for message in messages %}
                                <!-- Only show messages addressed to the session user -->
                                {% if message.recipient == session.user %}
                                    <li>
                                        <!-- Message Summary -->
                                        <div class="collapsible-header light-section">
                                            From: {{ message.sender }} |
                                            Subject:{{ message.subject }} |
                                            Sent at: {{ message.time }}
                                            <!-- Delete message  -->
                                            <a href="#confirm-delete-message{{ message._id }}" class="btn modal-trigger red">
                                                <i class="fa-regular fa-trash-can "></i>
                                            </a>
                                            <!-- Delete message confirmation -->
                                            <div id="confirm-delete-message{{ message._id }}" class="modal">
                                                <div class="modal-content">
                                                    <h4>Delete Message</h4>
                                                    <p>
                                                        Are you sure you want to delete this message? <br>
                                                        Message selected for deletion: <br>
                                                        From: {{ message.sender }} |
                                                        Subject:{{ message.subject }} |
                                                        Sent at: {{ message.time }} <br>
                                                        {{ message.body }}
                                                    </p>
                                                </div>
                                                <!-- Confirm or cancel delete buttons -->
                                                <div class="modal-footer">
                                                    <a href="{{ url_for('delete_message', message_id=message._id) }}"
                                                        class="modal-close btn-flat">Agree</a>
                                                    <div class="modal-close btn-flat">Cancel</div>
                                                </div>
                                            </div>
                                            <!-- Reply to message  -->
                                            <a href="#reply-to-message{{ message._id }}{{ message.sender }}{{ message.body }}{{ message.subject }}"
                                                class="btn modal-trigger">
                                                <i class="fa-solid fa-reply "></i>
                                            </a>
                                            <!-- Reply to message modal -->
                                            <div id="reply-to-message{{ message._id }}{{ message.sender }}{{ message.body }}{{ message.subject }}"
                                                class="modal">
                                                <!-- Message Content -->
                                                <div class="modal-content">
                                                    <h4>Reply to {{ message.sender }}</h4>
                                                    <div>
                                                        <h5> {{ message.sender }}'s message:</h5>
                                                        <p>
                                                            Subject:{{ message.subject }} <br>
                                                            {{ message.body }}
                                                        </p>
                                                    </div>
                                                    <!-- Reply form -->
                                                    <form method="POST" action="{{ url_for('new_message') }}">
                                                        <!-- Sender pre-filled field -->
                                                        <div class="row">
                                                            <div class="input-field col s12 hidden">
                                                                <input id="sender" name="sender" type="text" value=" {{ session.user }}"
                                                                    pattern="^[a-zA-Z\s]{2,}$">
                                                                <label for="sender">Sender</label>
                                                            </div>
                                                        </div>
                                                        <!-- Recipient pre-filled field -->
                                                        <div class="row">
                                                            <div class="input-field col s12 hidden">
                                                                <input id="recipient" name="recipient" type="text"
                                                                    value="{{ message.sender }}" pattern="^[a-zA-Z\s]{2,}$">
                                                                <label for="subject">Recipient</label>
                                                            </div>
                                                        </div>
                                                        <!-- Subject pre-filled field -->
                                                        <div class="row">
                                                            <div class="input-field col s12">
                                                                <input id="subject" name="subject" type="text"
                                                                    value="{{ message.subject }}" pattern="^[a-zA-Z\s]{2,}$" required>
                                                                <label for="subject">Subject</label>
                                                            </div>
                                                        </div>
                                                        <!-- Body field -->
                                                        <div class="row">
                                                            <div class="input-field col s12">
                                                                <textarea id="body" name="body" class="materialize-textarea"></textarea>
                                                                <label for="body">Type your message</label>
                                                            </div>
                                                        </div>
                                                        <!-- Send message button -->
                                                        <div class="row">
                                                            <button type="submit" class="col s12 btn-large">
                                                                Send <i class="fa-regular fa-paper-plane"></i>
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                                <!-- Cancel and close modal -->
                                                <div class="modal-footer">
                                                    <div class="modal-close btn-flat">Cancel</div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Message Content -->
                                        <div class="collapsible-body"><span>{{ message.body }}</span></div>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    <!-- If there are no messages to the user display message explaining list is empty -->
                    {% else %}
                        <h6>You have no new messages</h6>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Email Modal -->
    <form method="POST" action="{{ url_for('edit_user_email', user_id=user._id) }}" id="email-modal" class="modal">
        <div class="modal-content">
            <h4>Edit Email</h4>
            <!-- Email edit input field -->
            <div class="row">
                <div class="input-field col s12">
                    <i class="fas fa-at prefix"></i>
                    <input id="email-edit" name="email-edit" type="email" class="validate" required>
                    <label for="email-edit">Email</label>
                </div>
            </div>
        </div>
        <!-- Submit button -->
        <div class="modal-footer">
            <button type="submit" class="modal-close btn-flat">Update</a>
            <div class="modal-close btn-flat">Cancel</div>
        </div>
    </form>
    <!-- Edit Experience Modal -->
    <form method="POST" action="{{ url_for('edit_user_experience', user_id=user._id) }}" id="experience-modal" class="modal">
        <!-- Edit experience input field -->
        <div class="modal-content">
            <h4>Edit Experience</h4>
            <div class="row">
                <div class="input-field col s12">
                    <i class="fas fa-graduation-cap prefix"></i>
                    <select id="experience-edit" name="experience-edit" required>
                        <option value="0" selected></option>
                        <option value="1"><strong>Egg</strong> (What's a bird?)</option>
                        <option value="2"><strong>Hatchling</strong> (New to this)</option>
                        <option value="3"><strong>Fledgling</strong> (Garden birds only)</option>
                        <option value="4"><strong>Juvenile</strong> ("That's a Coot, not a Moorhen")</option>
                        <option value="5"><strong>Adult</strong> (Can identify 'that little flitty one')</option>
                        <option value="6"><strong>Owl</strong> (Have seen ALL the birds)</option>
                    </select>
                    <label for="experience-edit">Experience Level</label>
                </div>
            </div>
        </div>
        <!-- Submit or cancel buttons -->
        <div class="modal-footer">
            <button type="submit" class="modal-close btn-flat">Update</a>
            <div class="modal-close btn-flat">Cancel</div>
        </div>
    </form>
    <!-- Delete Account Modal -->
    <div id="confirm-delete-account{{ user._id }}" class="modal">
        <div class="modal-content">
            <h4>Delete Account</h4>
            <p>
                Are you sure you want to delete your account? <br>
            </p>
            <p>
                Your observations will not be deleted with your account as they provide important information and statistics which helps
                us with our bird research. All off your observations will appear in the community observations and as if created by an 
                anonymous user, so the community will not know these are your observations. 
            </p>
        </div>
        <!-- Confrim or cancel buttons -->
        <div class="modal-footer">
            <a href="{{ url_for('delete_user', user_id=user._id) }}" class="modal-close btn-flat">Yes, delete</a>
            <div class="modal-close btn-flat">No, cancel</div>
        </div>
    </div>
</div>
{% endblock %}